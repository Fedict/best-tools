<?xml version="1.0" encoding="UTF-8"?>
<job id="bestTransfer" xmlns="http://xmlns.jcp.org/xml/ns/javaee"
	 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd"
     version="1.0">
	<listeners>
		<listener ref="mailLogListener">
			<properties>
				<property name="server" value="#{jobParameters['mail.server]}"/>				
				<property name="from" value="#{jobParameters['mail.from]}"/>
				<property name="to" value="#{jobParameters['mail.to]}"/>
				<property name="subject" value="Best transfer batch"/>
				<property name="message" value=""/>
			</properties>
		</listener>
	</listeners>
	<flow id="download-flow" next="unzip-flow">
		<fail on="FAILED" exit-status="DOWNLOAD_FAILED"/>
		<step id="download-step" start-limit="3" allow-start-if-complete="true">
			<batchlet ref="sftpBatchlet">
				<properties>
					<property name="fromSite" value="#{jobParameters['sftp.from.site']}"/>
					<property name="fromUser" value="#{jobParameters['sftp.from.user]}"/>
					<property name="fromPass" value="#{jobParameters['sftp.from.pass']}"/>
					<property name="fromFile" value="#{jobParameters['sftp.from.file']}"/>
					<property name="toFile" value="#{systemProperties['java.io.tmpdir']}/best-full-latest.zip"/>
				</properties>
			</batchlet>
		</step>
	</flow>
	<flow id="unzip-flow" next="verify-flow">
		<fail on="FAILED" exit-status="UNZIP_FAILED"/>
		<step id="zipsize-step" next="unpack-step">
			<batchlet ref="verifyFileBatchlet">
				<properties>
					<property name="file" value="#{systemProperties['java.io.tmpdir']}/best-full-latest.zip"/>
					<property name="minSize" value="300000000"/>
				</properties>			
			</batchlet>
		</step>
		<step id="unpack-step">
			<batchlet ref="unpackBatchlet">
				<properties>
					<property name="inputFile" value="#{systemProperties['java.io.tmpdir']}/best-full-latest.zip"/>
					<property name="outputDir" value="#{systemProperties['java.io.tmpdir']}/best"/>
				</properties>
			</batchlet>
		</step>
	</flow>
	<flow id="verify-flow" next="upload-flow">
		<fail on="FAILED" exit-status="VERIFY_FAILED"/>
		<step id="vl-step" next="bxl-step">
			<batchlet ref="verifyFileBatchlet">
				<properties>
					<property name="directory" value="#{systemProperties['java.io.tmpdir']}/best"/>
					<property name="filterPattern" value="FlandersAddress.*zip"/>
					<property name="minSize" value="200000000"/>
				</properties>
			</batchlet>
		</step>
		<step id="bxl-step" next="wal-step">
			<batchlet ref="verifyFileBatchlet">
				<properties>
					<property name="directory" value="#{systemProperties['java.io.tmpdir']}/best"/>
					<property name="filterPattern" value="BrusselsAddress.*zip"/>
					<property name="minSize" value="30000000"/>
				</properties>
			</batchlet>
		</step>
		<step id="wal-step">
			<batchlet ref="verifyFileBatchlet">
				<properties>
					<property name="directory" value="#{systemProperties['java.io.tmpdir']}/best"/>
					<property name="filterPattern" value="WalloniaAddress.*zip"/>
					<property name="minSize" value="70000000"/>
				</properties>
			</batchlet>
		</step>
	</flow>
	<flow id="upload-flow">
		<fail on="FAILED" exit-status="UPLOAD_FAILED"/>
		<step id="upload-step" start-limit="3" allow-start-if-complete="true">
			<batchlet ref="sftpBatchlet">
				<properties>
					<property name="fromFile" value="#{systemProperties['java.io.tmpdir']}/best-full-latest.zip"/>
					<property name="toFile" value="#{jobParameters['sftp.to.file']}"/>
					<property name="toSite" value="#{jobParameters['sftp.to.site']}"/>
					<property name="toUser" value="#{jobParameters['sftp.to.user]}"/>
					<property name="toPass" value="#{jobParameters['sftp.to.pass']}"/>
				</properties>
			</batchlet>
		</step>
	</flow>
</job>
